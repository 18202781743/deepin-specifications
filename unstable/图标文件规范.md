# 图标文件规范

> __警告！此规范内容是不稳定版本，可能会发生破坏兼容性的更新。当无法保障向下兼容时，将会升级此文档的主版本号，如从“1.0”更新到“2.0”。反之，普通更新只会升级次版本号，如“1.0”更新到“1.1”，其对“1.0”版本向下兼容。请在使用前确认此文档的版本号，并为将来可能发生的兼容性变化做好准备。__

* 维护者：zccrs zhangjide@uniontech.com
* 版本：1.0
* 修改日期：2021.8.16
* 议题：#5

## 引言

本规范约定了各类图标文件的内部数据格式要求，以及此类文件的使用规范。

## 归档打包<a name="package"></a>

dci 文件（以下简称为 dci）为一种归档打包格式，其规定了如何将多个图标文件合并为一个文件。

### 格式

* 格式名称：`dci`，为 DSG combined icons 的缩写
* mimetype：image/dci，继承自：application/octet-stream
* magic：DCI，类型为 string，offset 为 0
* 此类型对应的图标名：image-dci
* 后缀名：dci

对应的 mimetype 描述文件内容：关于 mimetype 规范的详细设计请查看 <http://www.freedesktop.org/standards/shared-mime-info>

```xml
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
   <mime-type type="image/dci">
      <comment>DSG Icon file format</comment>
      <comment xml:lang="zh_CN">深度图标文件格式</comment>
      <glob pattern="*.dci"/>
      <icon name="image-dci"/>
      <magic priority="80">
        <match value="DCI" type="string" offset="0"/>
      </magic>
   </mime-type> 
</mime-info>

```

### 文件头

dci 使用小端序，文件的元数据位于文件开头。内容如下：

| 起始地址:结束地址 | 名称 | 大小 | 缺省值 |
| ---- | ---- | ---- | ---- |
| 0x0000:0x0003 | magic | 4B | DCI |
| 0x0004:0x0004 | 版本 | 1B |-|
| 0x0005:0x0007 | 文件数量 | 3B |-|
| 0x0008:0x0057 | 文件1元数据 | 72B |[格式](#file_format)|
| ... | 文件元数据 | - |[-](#file_format)|

> 这里的文件数量指根文件，不包含目录内的子文件。

> 文件顺序需按照其名称升序排列，此排列不区分文件类型。另外，需遵循[自然排序](http://www.naturalordersort.org/)（如“a2”在“a11”之前）规则。

### 文件的元数据 <a name="file_format"></a>

| 相对起始地址:相对结束地址 | 名称 | 大小 | 缺省值 |
| ---- | ---- | ---- | ---- |
| 0x0000:0x0000 | 文件类型 | 1B | [可选值](#file_type) |
| 0x0001:0x003F | 文件名 | 63B | - |
| 0x0040:0x0048 | 内容的大小 | 8B |-|
| 0x0049:0x???? | 内容 | - | - |

> 文件名为 UTF-8 编码，必须以 '\0' 结尾，且不可包含 '/' 字符。
>
> 目录的内容是：此目标内子目录以及文件的元数据和数据。

文件类型 <a name="file_type"></a>

| 值 | 类型 |
| ---- | ---- |
| 0 | 保留 |
| 1 | 文件 |
| 2 | 目录 |
| 3 | 链接 |

> 目录文件也属于文件类型的一种，可在目录下嵌套子目录。

> 目录内的文件顺序需按照其名称升序排列，此排列不区分文件类型。另外，需遵循[自然排序](http://www.naturalordersort.org/)（如“a2”在“a11”之前）规则。

### 链接文件

链接的目标可以是“文件”或其它（不可链接自身）“链接”，否则认为此链接目标无效。创建链接时不检查链接的目标是否存在，对链接文件内容的读写操作等价于读写链接的目标，如若链接目标无效或不存在，则读写失败。获取链接的目标路径时，如果链接文件无效，需给出一个空路径。

链接文件的内容格式：

| 相对起始地址:相对结束地址 | 名称 | 大小 | 缺省值 |
| ---- | ---- | ---- | ---- |
| 0x0000:0x???? | 目标路径 | 取决于元数据中指定的内容大小 | - |

> 内容编码为 UTF-8，路径需符合 UNIX 标准，可使用相对路径。相对路径的 "." 和 ".." 仅可用于路径的开头，当"."、".."出现在路径中间时，如 "/./test.txt"、"../a/../"，此处的"."和".."需当作文件名称处理。

## 图标文件规范

在[归档打包](#package)中描述了 dci 文件的归档规范，本章节将描述 dci 格式的文件目录结构和命名规范。

### 图标状态

图标适应环境变化时所需要展现的不同形态，分为以下四种状态：

* Normal：缺省状态
* Disabled：被禁用时的状态，一般表现为不再响应鼠标、键盘等输入事件
* Hover：鼠标悬浮在图标上的状态
* Pressed：点击后且未释放时的状态

> 当图标只提供 Normal 状态的文件时，可使用一些固定规则对 Normal 状态进行加工而得到其它状态，此规范不约束加工后的效果。

### 图标种类

为适应不同的界面环境，图标分为以下三类：

* Text：纯文本性图标，其颜色需跟随画笔的前景色变化，在实际使用中，需将其填充为上下文环境中的文本颜色
* Action：动作型图标，其颜色在非 Normal 状态时的行为与 Text 类型的图标一致
* Icon：图标型图标，其颜色在任何状态下都不会变化

### 缩放倍数

为适应不同的 DPI，图标大小的缩放倍数分类以下三类：

* 1：无缩放
* 2：放大2倍
* 3：放大3倍

### 色调类型

为适应不同的明暗色，图标按色调可分为以下两类：

* Generic：通用类型，在亮色和暗色环境中均适用
* Light：仅可用于亮色环境
* Dark：仅可用于暗色环境

一个图标可能包含 `图标种类 x 图标状态 x 缩放倍数 x 色调类型 = 72` 个图片文件，以名称为 `dde` 的图标举例，封装为 dci 格式后的目录结构如下：

```txt
├── 16
│   ├── text-disabled-generic.webp
│   │   ├── foreground@1
│   │   ├── foreground@2
│   │   └── foreground@3
│   └── text-normal-light.webp
│       ├── background@1
│       ├── background@2
│       ├── background@3
│       ├── foreground@1
│       ├── foreground@2
│       └── foreground@3
└── 24
    ├── action-hover-dark.webp
    |   ├── background@1
    |   ├── background@2
    |   ├── background@3
    │   ├── foreground@1
    │   ├── foreground@2
    │   └── foreground@3
    └── icon-pressed-dark.webp
        ├── background@1
        ├── background@2
        ├── background@3
        ├── foreground@1
        ├── foreground@2
        └── foreground@3
```

* 一级目录按图标大小创建，目录名必须为整数数字
* 二级目录的名称格式为：`{图标种类}-{图标状态}-{色调类型}.{图片格式对应的文件后缀名}`，文件名中的每一项均不可省略
* 三级目录中是图片文件，其中 `"foreground@{缩放倍数}"` 必须存在，`"background@{缩放倍数}"` 为可选，图片需支持 webp、png 格式，且同一目录下的 "foreground@{缩放倍数}" 和 "background@{缩放倍数}" 图片的格式必须相同。如若存在 "background@{缩放倍数}"，则对应缩放倍数的 "foreground@{缩放倍数}" 文件也必须存在

目录/文件名中各项变量的可选值：

|变量|可选值|备注|
|----|----|----|
|图标种类|"text"、"action"、"icon"|查找图标时类型必须完全匹配|
|图标状态|"normal"、"disabled"、"hover"、"pressed"|normal状态的图标必须存在，其它状态为可选，查找图标时，如果对应状态不存在，则允许使用normal状态代替|
|色调类型|"generic"、"light"、"dark"|generic类的图标可用于Light或Dark环境，但是light类的图标不可用于Dark环境，其它情况类似|
|后缀名|"webp"、"png"|webp允许使用动态内容，当状态变化引起的图标更新时需播放动画，其它情况不播放，如提供了其它格式的图片，行为以渲染方为准|
|缩放倍数|"1"、"2"、"3"|至少要提供此三类缩放比例的图标，其它更高的缩放为可选，如目标缩放倍数的图片不存在，则可以选用更高倍数的图，如无更高倍数的图，则可以使用低倍数中较高的图片|
