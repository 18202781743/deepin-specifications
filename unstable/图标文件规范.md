# 图标文件规范

> __警告！此规范内容是不稳定版本，可能会发生破坏兼容性的更新。当无法保障向下兼容时，将会升级此文档的主版本号，如从“1.0”更新到“2.0”。反之，普通更新只会升级次版本号，如“1.0”更新到“1.1”，其对“1.0”版本向下兼容。请在使用前确认此文档的版本号，并为将来可能发生的兼容性变化做好准备。__

* 维护者：zccrs zhangjide@uniontech.com
* 版本：1.0
* 修改日期：2021.8.16
* 议题：#5

## 引言

本规范约定了各类图标文件的内部数据格式要求，以及此类文件的使用规范。

## 归档打包<a name="package"></a>

dci 文件（以下简称为 dci）为一种归档打包格式，其规定了如何将多个图标文件合并为一个文件。

### 格式

* 格式名称：`dci`，为 deepin combined icons 的缩写
* mimetype：image/dci，继承自：application/octet-stream
* magic：DCI，类型为 string，offset 为 0
* 此类型对应的图标名：image-dci
* 后缀名：dci

对应的 mimetype 描述文件内容：关于 mimetype 规范的详细设计请查看 <http://www.freedesktop.org/standards/shared-mime-info>

```xml
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
   <mime-type type="image/dci">
      <comment>Deepin Icon file format</comment>
      <comment xml:lang="zh_CN">深度图标文件格式</comment>
      <glob pattern="*.dci"/>
      <icon name="image-dci"/>
      <magic priority="80">
        <match value="DCI" type="string" offset="0"/>
      </magic>
   </mime-type> 
</mime-info>

```

### 文件头

dci 使用小端序，文件的元数据位于文件开头。内容如下：

| magic | 版本 | 校验和 |
| ---- | ---- | ---- |
| DCI | 1B | 16B |
| __文件数量__ | __文件1元数据__ | __文件n元数据__ |
| 1B | ... |

### 文件的元数据分为两类

* 普通文件元数据：
    | 标识 | 名称 | 文件内容开始的偏移 | 文件内容结束的偏移 |
    | ---- | ---- | ---- |---- |
    | 0x0f | 64B | 8B | 8B |

* 目录文件元数据：
    | 标识 | 名称 | 子文件数量 | 子文件1元数据 | ... | 子文件n元数据 |
    | ---- | ---- | ---- | ---- | ---- |---- |
    | 0x0d | 64B | 1B | ... | |

目录文件也属于文件类型的一种，可在目录下嵌套子目录。

### 校验和的计算方法

```cpp
check_sum_data; // 参与校验和计算的数据
head_data; // 文件头的元数据，即开头的4个字节
contents_data; // 文件内部数据，从“校验和”后面的“文件数量”开始，一直到 dci 文件内容结束
check_sum_data.append(head_data);
check_sum_data.append(contents_data)
check_sum = checkSum(check_sum_data);
```

每次修改dci文件内容后，应当重新计算`校验和`，并将计算结果更新到文件头的 __校验和__ 部分。

## 图标文件规范

在[归档打包](#package)中描述了 dci 文件的归档规范，本章节将描述允许打包为 dci 格式的文件目录结构和命名规范。

### 图标状态

图标适应环境变化时所需要展现的不同形态，分为以下四种状态：

* Normal：缺省状态
* Disabled：被禁用时的状态，一般表现为不再响应鼠标、键盘等输入事件
* Active：一般对应到鼠标悬浮在图标上的状态
* Selected：一般对应到存在选中背景的状态，如图标所在的列表项被选中

> 当图标只提供 Normal 状态的文件时，可使用一些固定规则对 Normal 状态进行加工而得到其它状态，由渲染方决定此规则

### 图标种类

为适应不同的界面环境，图标分为以下三类：

* Text：纯文本性图标，其颜色需跟随画笔的前景色变化，在实际使用中，需将其填充为上下文环境中的文本颜色
* Action：动作型图标，其颜色在非 Normal 状态时的行为与 Text 类型的图标一致
* Icon：图标型图标，其颜色在任何状态下都不会变化

### 缩放倍数

为适应不同的 DPI，图标大小的缩放倍数分类以下三类：

* 1x：无缩放
* 2x：放大2倍
* 3x：放大3倍

### 色调类型

为适应不同的明暗色，图标按色调可分为以下两类：

* Light
* Dark

一个图标可包含 `图标状态 x 图标种类 x 缩放倍数 x 色调类型 = 72` 个图片文件，以名称为 `dde` 的图标举例，封装为 dci 格式后的目录结构如下：

```txt
├── 16-text
│ ├── background.png
│ ├── normal.png
│ ├── normal@2x.png
│ ├── normal-dark.png
│ ├── disabled.png
│ ├── hover.png
│ ├── pressed.png
...
│ ├── selected.png
├── 32-text
...
├── 64-action
```

* "16-text"、"32-text"、"64-action" 为子目录，目录名格式为："\$图标大小-$图标类型"
* 每种大小的图标只能存在一类，比如当前已经存在"16-text"，不能再有"16-action"，否则只能保证其中一类可以生效（不确定具体是哪种类型生效），其余类型将被忽略
* background.png：在图标内容绘制之前绘制，无论此图标是什么类型，都将保持原样绘制，如 16-text 中的 background.png 也不会跟随文字颜色。
* normal.png ... selected.png 对应为图标的不同状态，除 Normal 状态外，其它状态的图标文件可不提供
* 对图标内容的文件格式没有要求，只需要是位图图形格式即可，示例中所使用的是 png 格式，可根据实际需要使用 jpeg、bmp 等格式，本规范只要求必须支持 “png”、“jpeg”、“bmp”、“apng” 格式，对于其它格式取决于此规范的实现者，不保证都可以支持
